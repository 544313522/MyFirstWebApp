<!DOCTYPE html>
<html>
<head>
    <title>仪表板</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
        }
        .nav-link {
            color: #495057;
            margin-bottom: 10px;
        }
        .nav-link:hover {
            color: #007bff;
        }
        .nav-link.active {
            color: #007bff;
            font-weight: bold;
        }
        .content-area {
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-2 sidebar">
                <h4 class="mb-4">功能菜单</h4>
                <div class="nav flex-column" id="sidebarMenu">
                    <!-- 菜单项将通过 JavaScript 动态加载 -->
                </div>
            </div>

            <!-- 主要内容区域 -->
            <div class="col-md-10 content-area">
                <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                    <span class="navbar-brand">欢迎回来</span>
                    <div class="navbar-nav ml-auto">
                        <a class="nav-item nav-link" href="#" onclick="logout()">退出登录</a>
                    </div>
                </nav>
                <div id="contentArea">
                    <!-- 内容将根据选择的菜单动态加载 -->
                    <h2>请从左侧选择功能</h2>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始化配置
        let config = {
            token: null,
            apiEndpoints: {
                auth: '/api/check-auth',  // 用户认证接口
                users: '/api/users'       // 用户管理接口
            }
        };

        // 安全地获取token
        try {
            const token = sessionStorage.getItem('token');
            if (token) {
                config.token = token;
            }
        } catch (e) {
            console.warn('无法访问 sessionStorage:', e);
        }
        
        // 菜单项配置：定义所有可用的功能模块
        const menuItems = [
            { id: 'user-management', title: '用户管理', adminOnly: true },  // 仅管理员可见
            { id: 'youtube-downloader', title: 'YouTube下载器', adminOnly: false },  // 所有用户可见
            { id: 'whisper-ai', title: 'Whisper AI', adminOnly: false },
            { id: 'translator', title: '翻译工具', adminOnly: false },
            { id: 'summarizer', title: '文本摘要', adminOnly: false },
            { id: 'snake-game', title: '贪吃蛇', adminOnly: false },
            { id: 'spaceship', title: '宇宙飞船', adminOnly: false },
            { id: 'module-1', title: '待确定板块1', adminOnly: false },
            { id: 'module-2', title: '待确定板块2', adminOnly: false },
            { id: 'module-3', title: '待确定板块3', adminOnly: false },
            { id: 'module-4', title: '待确定板块4', adminOnly: false }
        ];

        // API 请求工具
        const api = {
            get headers() {
                return {
                    'Authorization': `Bearer ${config.token}`,
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                };
            },
            
            // GET请求方法
            async get(url) {
                try {
                    console.log('发送GET请求:', url);
                    console.log('请求头:', this.headers);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: this.headers,
                        credentials: 'same-origin',
                        mode: 'cors'
                    });

                    console.log('收到响应:', {
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries())
                    });

                    // 错误处理
                    if (!response.ok) {
                        console.error('请求失败:', response.status, response.statusText);
                        throw new Error(`请求失败: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('响应数据:', data);
                    return data;
                } catch (error) {
                    console.error('API 请求错误:', error);
                    throw error;
                }
            },

            async post(url, data) {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: this.headers,
                    body: JSON.stringify(data)
                });
                return response.json();
            },

            async put(url, data) {
                try {
                    console.log('发送PUT请求:', url);
                    console.log('请求头:', this.headers);
                    console.log('请求数据:', data);
                    
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: this.headers,
                        body: JSON.stringify(data),
                        credentials: 'same-origin',
                        mode: 'cors'
                    });
                    
                    console.log('收到响应:', {
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                    
                    // 错误处理
                    if (!response.ok) {
                        console.error('请求失败:', response.status, response.statusText);
                        throw new Error(`请求失败: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('响应数据:', result);
                    return result;
                } catch (error) {
                    console.error('API PUT请求错误:', error);
                    throw error;
                }
            },  // 这里缺少了一个逗号

            async delete(url) {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: this.headers
                });
                return response.json();
            }
        };

        // 退出登录
        function logout() {
            sessionStorage.removeItem('token');
            window.location.href = '/';
        }

        // 加载菜单
        // 在加载菜单函数中添加更详细的日志
        async function loadMenu() {
            try {
                // 先验证 token
                if (!config.token) {
                    throw new Error('未登录');
                }
        
                console.log('开始加载菜单...');
                console.log('当前token:', config.token);
        
                const data = await api.get(config.apiEndpoints.auth);
                console.log('认证响应原始数据:', JSON.stringify(data, null, 2));
                
                if (!data || data.status !== 'success' || !data.user) {
                    console.error('认证响应无效:', data);
                    throw new Error('无效的认证响应');
                }
        
                console.log('用户认证成功:', {
                    user: data.user,
                    isAdmin: data.is_admin,
                    status: data.status,
                    authenticated: data.authenticated
                });
        
                const sidebarMenu = document.getElementById('sidebarMenu');
                if (!sidebarMenu) {
                    throw new Error('菜单容器不存在');
                }
        
                sidebarMenu.innerHTML = '';
                
                // 添加用户信息
                const userInfo = document.createElement('div');
                userInfo.className = 'mb-4 text-muted';
                userInfo.textContent = `当前用户: ${data.user}${data.is_admin ? ' (管理员)' : ''}`;
                sidebarMenu.appendChild(userInfo);
                
                // 加载菜单项
                let visibleMenuCount = 0;
                let adminMenuCount = 0;
                let normalMenuCount = 0;
                
                console.log('开始处理菜单项...');
                console.log('总菜单项数量:', menuItems.length);
        
                menuItems.forEach((item, index) => {
                    // 判断是否显示菜单项
                    let shouldShow = false;
                    
                    if (data.is_admin) {
                        // 管理员可以看到所有菜单
                        shouldShow = true;
                    } else {
                        // 普通用户根据权限判断
                        if (item.adminOnly) {
                            // 管理员专属功能，普通用户不可见
                            shouldShow = false;
                        } else {
                            // 检查用户是否有权限访问此功能
                            shouldShow = data.permissions && data.permissions[item.id] === true;
                        }
                    }
                    
                    console.log(`处理菜单项 [${index + 1}/${menuItems.length}] ${item.title}:`, {
                        adminOnly: item.adminOnly,
                        isAdmin: data.is_admin,
                        hasPermission: shouldShow,
                        permissionValue: data.permissions ? data.permissions[item.id] : undefined,
                        permissionKey: item.id
                    });
                    
                    if (item.adminOnly) {
                        adminMenuCount++;
                    } else {
                        normalMenuCount++;
                    }
                    
                    if (shouldShow) {
                        const link = document.createElement('a');
                        link.href = '#';
                        link.className = 'nav-link';
                        link.textContent = item.title;
                        link.onclick = (event) => {
                            event.preventDefault();
                            loadContent(item.id, event);
                        };
                        sidebarMenu.appendChild(link);
                        visibleMenuCount++;
                        console.log(`已添加菜单项: ${item.title}`);
                    }
                });
                
                console.log('用户权限数据:', data.permissions);
                
                // 在处理完所有菜单项后添加
                console.log('菜单统计:', {
                    total: menuItems.length,
                    adminOnly: adminMenuCount,
                    normal: normalMenuCount,
                    visible: visibleMenuCount,
                    permissions: data.permissions
                });
                
                if (visibleMenuCount === 0) {
                    console.warn('没有可显示的菜单项');
                    sidebarMenu.innerHTML += `
                        <div class="alert alert-warning">
                            未找到可显示的菜单项
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载菜单失败：', error);
                const sidebarMenu = document.getElementById('sidebarMenu');
                if (sidebarMenu) {
                    sidebarMenu.innerHTML = `
                        <div class="alert alert-danger">
                            加载菜单失败：${error.message}
                        </div>
                    `;
                }
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            }
        }

        // 加载内容区域
        // 添加一个全局变量来跟踪权限更改
        let pendingPermissionChanges = {};
        
        // 修改权限更新函数
        function trackPermissionChange(username, moduleId, enabled) {
            // 初始化用户的权限更改跟踪对象
            if (!pendingPermissionChanges[username]) {
                pendingPermissionChanges[username] = {};
            }
            
            // 记录权限更改
            pendingPermissionChanges[username][moduleId] = enabled;
            
            // 显示保存按钮
            const saveBtn = document.getElementById(`save-permissions-${username}`);
            if (saveBtn) {
                saveBtn.style.display = 'inline-block';
            }
            
            console.log(`已记录权限更改: ${username}.${moduleId} = ${enabled}`);
            console.log('待保存的权限更改:', pendingPermissionChanges);
        }
        
        // 添加保存权限的函数
        // 修改保存权限的函数，添加更详细的错误处理和日志
        async function savePermissions(username) {
            try {
                if (!pendingPermissionChanges[username] || Object.keys(pendingPermissionChanges[username]).length === 0) {
                    console.log('没有需要保存的权限更改');
                    return;
                }
                
                console.log('准备保存权限更改，检查认证信息...');
                if (!config.token) {
                    throw new Error('未找到认证令牌，请重新登录');
                }
                
                // 获取当前用户的所有权限
                const response = await api.get(`/api/users/${username}/permissions`);
                console.log('当前权限:', response);
                
                // 合并权限更改
                const updatedPermissions = { ...response };
                for (const [moduleId, enabled] of Object.entries(pendingPermissionChanges[username])) {
                    updatedPermissions[moduleId] = enabled;
                }
                
                console.log('更新后的权限:', updatedPermissions);
                console.log('发送请求头:', api.headers);
                
                // 发送更新请求
                const result = await api.put(`/api/users/${username}/permissions`, updatedPermissions);
                console.log('更新结果:', result);
                
                if (result.msg === 'Permissions updated successfully') {
                    alert(`已成功更新用户 ${username} 的权限设置`);
                    // 清除该用户的待保存更改
                    delete pendingPermissionChanges[username];
                    // 隐藏保存按钮
                    const saveBtn = document.getElementById(`save-permissions-${username}`);
                    if (saveBtn) {
                        saveBtn.style.display = 'none';
                    }
                } else {
                    throw new Error(result.msg || '权限更新失败');
                }
            } catch (error) {
                console.error('保存权限失败:', error);
                // 提供更详细的错误信息
                let errorMessage = error.message;
                if (error.message.includes('401')) {
                    errorMessage = '认证失败，请重新登录后再试';
                    // 可能需要重新登录
                    setTimeout(() => {
                        logout();
                    }, 3000);
                }
                
                alert('保存权限失败: ' + errorMessage);
            }
        }

        // 修改用户管理页面的表格部分
        function loadContent(menuId, event) {
            const contentArea = document.getElementById('contentArea');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (event) {
                event.target.classList.add('active');
            }
            
            // 在 loadContent 函数中的用户管理部分
            if (menuId === 'user-management') {
                api.get(config.apiEndpoints.users)
                    .then(async users => {
                        // 获取每个用户的权限
                        const usersWithPermissions = await Promise.all(users.map(async user => {
                            if (!user.is_admin) {
                                const response = await api.get(`/api/users/${user.username}/permissions`);
                                return { ...user, permissions: response };
                            }
                            return user;
                        }));
            
                        contentArea.innerHTML = `
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h4>添加新用户</h4>
                                </div>
                                <div class="card-body">
                                    <form id="createUserForm">
                                        <div class="form-group">
                                            <label>用户名</label>
                                            <input type="text" class="form-control" id="username" required>
                                        </div>
                                        <div class="form-group">
                                            <label>密码</label>
                                            <input type="password" class="form-control" id="password" required>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input type="checkbox" class="form-check-input" id="isAdmin">
                                            <label class="form-check-label">管理员权限</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary">创建用户</button>
                                    </form>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h4>用户列表</h4>
                                </div>
                                <div class="card-body">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <td>用户名</td>
                                                <td>角色</td>
                                                <td>重置密码</td>
                                                ${menuItems.filter(item => !item.adminOnly).map(item => 
                                                    `<td>${item.title}</td>`
                                                ).join('')}
                                                <td>操作</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${usersWithPermissions.map(user => `
                                                <tr>
                                                    <td>${user.username}</td>
                                                    <td>${user.is_admin ? '管理员' : '普通用户'}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-warning" onclick="resetPassword('${user.username}')">
                                                            重置密码
                                                        </button>
                                                    </td>
                                                    ${!user.is_admin ? menuItems.filter(item => !item.adminOnly).map(item => `
                                                        <td>
                                                            <div class="custom-control custom-checkbox">
                                                                <input type="checkbox" 
                                                                    class="custom-control-input" 
                                                                    id="${user.username}_${item.id}"
                                                                    ${user.permissions && user.permissions[item.id] ? 'checked' : ''}
                                                                    onchange="trackPermissionChange('${user.username}', '${item.id}', this.checked)">
                                                                <label class="custom-control-label" for="${user.username}_${item.id}"></label>
                                                            </div>
                                                        </td>
                                                    `).join('') : menuItems.filter(item => !item.adminOnly).map(() => `
                                                        <td>管理员</td>
                                                    `).join('')}
                                                    <td>
                                                        ${!user.is_admin ? 
                                                            `<button id="save-permissions-${user.username}" class="btn btn-sm btn-success" 
                                                                style="display: none;" 
                                                                onclick="savePermissions('${user.username}')">
                                                                保存权限
                                                            </button>` 
                                                            : ''}
                                                        ${user.username !== 'admin' ? 
                                                            `<button class="btn btn-sm btn-danger" onclick="deleteUser('${user.username}')">删除</button>` 
                                                            : ''}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('createUserForm').onsubmit = function(e) {
                            e.preventDefault();
                            const username = document.getElementById('username').value;
                            const password = document.getElementById('password').value;
                            const isAdmin = document.getElementById('isAdmin').checked;
                    
                            api.post(config.apiEndpoints.users, { 
                                username, 
                                password, 
                                is_admin: isAdmin 
                            })
                            .then(data => {
                                alert(data.msg);
                                if (data.msg === 'User created successfully') {
                                    loadContent('user-management');
                                }
                            });
                        };
                    });
            } else {
                // 统一处理其他所有功能模块
                const menuItem = menuItems.find(item => item.id === menuId);
                contentArea.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h2>${menuItem.title}</h2>
                        </div>
                        <div class="card-body">
                            <p>该功能正在开发中...</p>
                        </div>
                    </div>`;
            }
        }

        // 用户管理相关函数
        function deleteUser(username) {
            if (confirm(`确定要删除用户 ${username} 吗？`)) {
                api.delete(`${config.apiEndpoints.users}/${username}`)
                    .then(data => {
                        alert(data.msg);
                        loadContent('user-management');
                    });
            }
        }

        function resetPassword(username) {
            const newPassword = prompt(`请输入 ${username} 的新密码：`);
            if (newPassword) {
                api.put(`${config.apiEndpoints.users}/${username}/password`, {
                    password: newPassword
                })
                .then(data => {
                    alert(data.msg);
                });
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            let token;
            try {
                token = sessionStorage.getItem('token');
            } catch (e) {
                console.error('无法访问 sessionStorage:', e);
                token = null;
            }

            if (!token) {
                window.location.href = '/';
                return;
            }

            loadMenu().catch(error => {
                console.error('初始化失败：', error);
            });
        });
    </script>
</body>
</html>